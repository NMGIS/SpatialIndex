<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Index Performance Demo</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- App CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Spatial Indexing Performance Demo</h1>
        <p>Compare query speeds with and without PostGIS spatial indexes</p>
    </header>

    <main>
        <div class="controls">
            <button id="run-query-btn">Run Spatial Query</button>
            <span class="query-desc">Queries the current map extent (bounding box)</span>
        </div>
        <div class="scoreboard-wrapper">
            <div class="scoreboard">
                <span class="score indexed-score">Indexed faster: <strong id="score-indexed">0</strong></span>
                <span class="score-divider">|</span>
                <span class="score no-index-score">Non-indexed faster: <strong id="score-no-index">0</strong></span>
                <span class="score-divider">|</span>
                <span class="score tie-score">Tie: <strong id="score-tie">0</strong></span>
                <button id="reset-score-btn" title="Reset score">Reset</button>
            </div>
        </div>

        <div class="maps-container">
            <div class="map-panel">
                <div class="map-header">
                    <h2>Without Spatial Index</h2>
                    <div class="timing">
                        <div class="timing-row">
                            <span class="label">DB time:</span>
                            <span id="db-time-no-index" class="time db-time">--</span>
                        </div>
                        <div class="timing-row timing-row-secondary">
                            <span class="label">Client time:</span>
                            <span id="time-no-index" class="time client-time">--</span>
                        </div>
                    </div>
                </div>
                <div id="map-no-index" class="map"></div>
                <div class="results">
                    <span>Polygons found: <span id="count-no-index">--</span></span>
                </div>
            </div>

            <div class="map-panel">
                <div class="map-header">
                    <h2>With Spatial Index</h2>
                    <div class="timing">
                        <div class="timing-row">
                            <span class="label">DB time:</span>
                            <span id="db-time-indexed" class="time db-time">--</span>
                        </div>
                        <div class="timing-row timing-row-secondary">
                            <span class="label">Client time:</span>
                            <span id="time-indexed" class="time client-time">--</span>
                        </div>
                    </div>
                </div>
                <div id="map-indexed" class="map"></div>
                <div class="results">
                    <span>Polygons found: <span id="count-indexed">--</span></span>
                </div>
            </div>
        </div>

        <div class="stats-panel">
            <h3>PostgreSQL Index Statistics <span class="stats-label">(live from database)</span></h3>
            <div class="stats-grid">
                <div class="stats-column">
                    <h4>Indexed Table</h4>
                    <div class="stat-row">
                        <span class="stat-label">Index scans:</span>
                        <span id="stat-idx-scan" class="stat-value">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Tuples read (index):</span>
                        <span id="stat-idx-tup-read" class="stat-value">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Tuples fetched:</span>
                        <span id="stat-idx-tup-fetch" class="stat-value">--</span>
                    </div>
                </div>
                <div class="stats-column">
                    <h4>Non-Indexed Table</h4>
                    <div class="stat-row">
                        <span class="stat-label">Sequential scans:</span>
                        <span id="stat-seq-scan" class="stat-value">--</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Tuples read (seq):</span>
                        <span id="stat-seq-tup-read" class="stat-value">--</span>
                    </div>
                </div>
            </div>
            <p class="stats-hint">Index reads &gt; fetched = the index is filtering efficiently. Compare with sequential scan totals.</p>
        </div>

        <div class="info-panel">
            <h3>How it works</h3>
            <p>
                Both maps query identical datasets stored in Supabase (PostgreSQL + PostGIS).
                The left table has no spatial index, while the right table uses a GiST index
                on the geometry column. Pan/zoom the maps and click "Run Spatial Query" to
                see the performance difference.
            </p>
            <h3>Why do we randomize the query order?</h3>
            <p>
                Databases cache recently accessed data in memory. Whichever query runs first
                has to load data from disk, while the second query gets a free speed boost
                because that data is already in memory. To keep the comparison fair, we
                randomly pick which query goes first each time. Run several queries and
                watch the scoreboard for a balanced picture.
            </p>
            <h3>Why is the non-indexed query sometimes faster?</h3>
            <p>
                A spatial index helps the database skip directly to the relevant rows instead
                of scanning the entire table. But that shortcut has its own overhead. When
                the data is already cached in memory from a previous query, or when the search
                area is small enough that there isn't much to scan through, the non-indexed
                table can keep up or even win. The index advantage becomes more obvious on
                larger search areas with more data to sift through. Try zooming out and
                querying a bigger region to see it.
            </p>
        </div>
    </main>

    <footer>
        <p>Built with Leaflet, Supabase, and PostGIS</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- App JS -->
    <script src="js/env.js"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/map.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
