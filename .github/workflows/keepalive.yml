name: Supabase Weekly Keep Alive
on:
  schedule:
    - cron: "0 10 * * 0,3"
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest
    steps:
      - name: Query combined tables with random rows and columns
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          python3 - <<'EOF'
          import urllib.request
          import json
          import random
          import os

          url = os.environ["SUPABASE_URL"]
          key = os.environ["SUPABASE_ANON_KEY"]
          headers = {
              "apikey": key,
              "Authorization": f"Bearer {key}"
          }

          def query_random(table):
              offset = random.randint(0, 500)
              endpoint = f"{url}/rest/v1/{table}?select=*&limit=5&offset={offset}"
              req = urllib.request.Request(endpoint, headers=headers)
              with urllib.request.urlopen(req) as response:
                  data = json.loads(response.read())
              if not data:
                  # Offset may exceed table size, fall back to first row
                  endpoint = f"{url}/rest/v1/{table}?select=*&limit=1"
                  req = urllib.request.Request(endpoint, headers=headers)
                  with urllib.request.urlopen(req) as response:
                      data = json.loads(response.read())
              row = data[0]
              col = random.choice(list(row.keys()))
              print(f"[{table}] column='{col}', value='{row[col]}'")

          query_random("combined")
          query_random("combined_indexed")
          print("Done.")
          EOF